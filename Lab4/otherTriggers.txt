-- b) Триггер на изменение стоимости
CREATE TRIGGER Model_Update_Trigger
ON Model
AFTER UPDATE
AS
BEGIN
    -- Проверяем, обновляется ли цена
    IF UPDATE(dailyPrice)
    BEGIN
        DECLARE @modelId INT;
        DECLARE @modelName NVARCHAR(50);
        
        DECLARE model_cursor CURSOR FOR
        SELECT i.id, i.name
        FROM inserted i
        WHERE EXISTS (
            SELECT 1 
            FROM Car c
            JOIN Rental r ON c.licensePlate = r.carLicensePlate
            WHERE c.modelId = i.id
            AND r.status = 'Активна'
            AND r.actualReturnDate IS NULL
        );
        
        OPEN model_cursor;
        FETCH NEXT FROM model_cursor INTO @modelId, @modelName;
        
        -- Если найдены модели с авто в активном прокате - откатываем изменения
        IF @@FETCH_STATUS = 0
        BEGIN
            DECLARE @errorMsg NVARCHAR(500) = 'Нельзя изменить стоимость для моделей с автомобилями в активном прокате: ';
            DECLARE @modelsList NVARCHAR(500) = '';
            
            WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @modelsList = @modelsList + @modelName + ' (ID:' + CAST(@modelId AS NVARCHAR) + '), ';
                FETCH NEXT FROM model_cursor INTO @modelId, @modelName;
            END
            
            SET @modelsList = LEFT(@modelsList, LEN(@modelsList) - 1); -- Убираем последнюю запятую
            
            CLOSE model_cursor;
            DEALLOCATE model_cursor;
            
            -- Откатываем транзакцию
            ROLLBACK TRANSACTION;
            RAISERROR('%s%s', 16, 1, @errorMsg, @modelsList);
        END
        ELSE
        BEGIN
            CLOSE model_cursor;
            DEALLOCATE model_cursor;
            PRINT 'Стоимость проката успешно обновлена для выбранных моделей.';
        END
    END
END;
GO

CREATE TRIGGER Car_Delete_Trigger
ON Car
INSTEAD OF DELETE
AS
BEGIN
    DECLARE @licensePlate NVARCHAR(15);
    DECLARE @year INT;
    DECLARE @color NVARCHAR(20);
    DECLARE @condition NVARCHAR(20);
    DECLARE @modelId INT;
    
    DECLARE car_cursor CURSOR FOR
    SELECT licensePlate, year, color, condition, modelId
    FROM deleted;
    
    OPEN car_cursor;
    FETCH NEXT FROM car_cursor INTO @licensePlate, @year, @color, @condition, @modelId;
    
    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Проверка условий для удаления
        IF (YEAR(GETDATE()) - @year > 15)
           AND NOT EXISTS (SELECT 1 FROM Rental WHERE carLicensePlate = @licensePlate)
           AND @condition = 'Плохое'
        BEGIN
            -- Удаление автомобиля
            DELETE FROM Car WHERE licensePlate = @licensePlate;
            PRINT 'Автомобиль ' + @licensePlate + ' успешно удален.';
        END
        ELSE
        BEGIN
            DECLARE @errorMsg NVARCHAR(200) = 'Автомобиль ' + @licensePlate + ' не может быть удален. ';
            
            IF (YEAR(GETDATE()) - @year <= 15)
                SET @errorMsg = @errorMsg + 'Возраст менее 15 лет. ';
            
            IF EXISTS (SELECT 1 FROM Rental WHERE carLicensePlate = @licensePlate)
                SET @errorMsg = @errorMsg + 'Находился в прокате. ';
            
            IF @condition != 'Плохое'
                SET @errorMsg = @errorMsg + 'Состояние не "Плохое".';
                
            RAISERROR(@errorMsg, 16, 1);
        END
        
        FETCH NEXT FROM car_cursor INTO @licensePlate, @year, @color, @condition, @modelId;
    END
    
    CLOSE car_cursor;
    DEALLOCATE car_cursor;
END;
GO


PRINT '';

-- Тест 1.2: Все клиенты с нарушениями
PRINT 'Тест 1.2: Все клиенты имеют нарушения';
BEGIN TRY
    DECLARE @badOrderId1 INT, @badOrderId2 INT;
    
    INSERT INTO RentalOrder (createDate, status, totalPrice, clientPassport)
    VALUES 
        (GETDATE(), 'Создан', NULL, '4510 123456'),  -- Клиент с нарушениями
        (GETDATE(), 'Создан', NULL, '4510 654321');  -- Клиент с нарушениями
    
    SET @badOrderId1 = SCOPE_IDENTITY() - 1;
    SET @badOrderId2 = SCOPE_IDENTITY();
    
    INSERT INTO Rental (startDate, plannedReturnDate, rentalCost, status, carLicensePlate, rentalOrderId)
    VALUES 
        ('2025-07-20 10:00:00', '2025-07-25 10:00:00', 15000.00, 'Активна', 'А008АА777', @badOrderId1),
        ('2025-07-21 11:00:00', '2025-07-26 11:00:00', 20000.00, 'Активна', 'Е308ЕЕ777', @badOrderId2);
    
    DECLARE @badInsertedCount INT;
    SELECT @badInsertedCount = COUNT(*) FROM Rental WHERE rentalOrderId IN (@badOrderId1, @badOrderId2);
    
    PRINT 'Результат: Вставлено ' + CAST(@badInsertedCount AS NVARCHAR) + ' из 2 записей';
    
    IF @badInsertedCount = 0
        PRINT 'УСПЕХ: Все клиенты с нарушениями корректно заблокированы';
    ELSE
        PRINT 'ОШИБКА: Некоторые клиенты с нарушениями были ошибочно вставлены';
    
    -- Очистка
    DELETE FROM Rental WHERE rentalOrderId IN (@badOrderId1, @badOrderId2);
    DELETE FROM RentalOrder WHERE id IN (@badOrderId1, @badOrderId2);
    
END TRY
BEGIN CATCH
    PRINT 'ОШИБКА ВЫПОЛНЕНИЯ: ' + ERROR_MESSAGE();
    IF @badOrderId1 IS NOT NULL AND EXISTS (SELECT 1 FROM RentalOrder WHERE id = @badOrderId1) 
        DELETE FROM RentalOrder WHERE id = @badOrderId1;
    IF @badOrderId2 IS NOT NULL AND EXISTS (SELECT 1 FROM RentalOrder WHERE id = @badOrderId2) 
        DELETE FROM RentalOrder WHERE id = @badOrderId2;
END CATCH

PRINT '';

-- Тест 1.3: Проверка системы скидок
PRINT 'Тест 1.3: Проверка системы скидок для клиентов без нарушений';
BEGIN TRY
    DECLARE @discountOrder1 INT, @discountOrder2 INT;
    
    -- Клиенты с разным количеством завершенных аренд (без нарушений)
    INSERT INTO RentalOrder (createDate, status, totalPrice, clientPassport)
    VALUES 
        (GETDATE(), 'Создан', NULL, '4520 222222'),  -- 3+ аренд (скидка 5%)
        (GETDATE(), 'Создан', NULL, '4510 999999');  -- Мало аренд (без скидки)
    
    SET @discountOrder1 = SCOPE_IDENTITY() - 1;
    SET @discountOrder2 = SCOPE_IDENTITY();
    
    DECLARE @baseCost DECIMAL(10,2) = 10000.00;
    DECLARE @expectedCost1 DECIMAL(10,2) = @baseCost * 0.95;
    DECLARE @expectedCost2 DECIMAL(10,2) = @baseCost;
    
    INSERT INTO Rental (startDate, plannedReturnDate, rentalCost, status, carLicensePlate, rentalOrderId)
    VALUES 
        ('2025-07-20 10:00:00', '2025-07-25 10:00:00', @baseCost, 'Активна', 'А008АА777', @discountOrder1),
        ('2025-07-21 11:00:00', '2025-07-26 11:00:00', @baseCost, 'Активна', 'Е308ЕЕ777', @discountOrder2);
    
    -- Проверяем результаты
    DECLARE @finalCost1 DECIMAL(10,2), @finalCost2 DECIMAL(10,2);
    
    SELECT @finalCost1 = rentalCost FROM Rental WHERE rentalOrderId = @discountOrder1; -- Должна быть скидка 5%
    SELECT @finalCost2 = rentalCost FROM Rental WHERE rentalOrderId = @discountOrder2; -- Без скидки
    
    PRINT 'Базовая стоимость: ' + CAST(@baseCost AS NVARCHAR);
    PRINT 'Клиент 4520 222222 (3+ аренд): ' + CAST(@finalCost1 AS NVARCHAR) + ' (ожидается: ' + CAST(@expectedCost1 AS NVARCHAR) + ')';
    PRINT 'Клиент 4510 999999 (мало аренд): ' + CAST(@finalCost2 AS NVARCHAR) + ' (ожидается: ' + CAST(@expectedCost2 AS NVARCHAR) + ')';
    
    -- Проверяем расчет скидки
    IF @finalCost1 = @expectedCost1
        PRINT 'УСПЕХ: Скидка 5% применена корректно';
    ELSE
        PRINT 'ОШИБКА: Неправильный расчет скидки 5%';
    
    IF @finalCost2 = @expectedCost2
        PRINT 'УСПЕХ: Отсутствие скидки обработано корректно';
    ELSE
        PRINT 'ОШИБКА: Неправильный расчет при отсутствии скидки';
    
    -- Очистка
    DELETE FROM Rental WHERE rentalOrderId IN (@discountOrder1, @discountOrder2);
    DELETE FROM RentalOrder WHERE id IN (@discountOrder1, @discountOrder2);
    
END TRY
BEGIN CATCH
    PRINT 'ОШИБКА ВЫПОЛНЕНИЯ: ' + ERROR_MESSAGE();
    IF @discountOrder1 IS NOT NULL AND EXISTS (SELECT 1 FROM RentalOrder WHERE id = @discountOrder1) 
        DELETE FROM RentalOrder WHERE id = @discountOrder1;
    IF @discountOrder2 IS NOT NULL AND EXISTS (SELECT 1 FROM RentalOrder WHERE id = @discountOrder2) 
        DELETE FROM RentalOrder WHERE id = @discountOrder2;
END CATCH

PRINT '=== ТЕСТИРОВАНИЕ ЗАВЕРШЕНО ===';
PRINT '=== ТЕСТ 2: ПОСЛЕДУЮЩИЙ триггер на изменение стоимости ===';

-- Тест 2.1: Попытка изменить стоимость модели с автомобилями в активном прокате
PRINT 'Тест 2.1: Изменение стоимости для модели в активном прокате (последующий триггер)';
BEGIN TRY
    -- Находим модель, у которой есть автомобили в активном прокате
    DECLARE @activeModelId INT;
    SELECT TOP 1 @activeModelId = m.id
    FROM Model m
    JOIN Car c ON m.id = c.modelId
    JOIN Rental r ON c.licensePlate = r.carLicensePlate
    WHERE r.status = 'Активна' AND r.actualReturnDate IS NULL;
    
    IF @activeModelId IS NOT NULL
    BEGIN
        UPDATE Model SET dailyPrice = dailyPrice * 1.1 WHERE id = @activeModelId;
        PRINT 'ОШИБКА: Триггер не сработал!';
    END
    ELSE
    BEGIN
        PRINT 'ПРОПУЩЕНО: Нет моделей с активными прокатами для теста';
    END
END TRY
BEGIN CATCH
    PRINT 'УСПЕХ: ' + ERROR_MESSAGE();
END CATCH

-- Тест 2.2: Изменение стоимости модели без активных прокатов (должно работать)
PRINT 'Тест 2.2: Изменение стоимости для модели без активных прокатов';
BEGIN TRY
    -- Находим модель без активных прокатов
    DECLARE @inactiveModelId INT;
    SELECT TOP 1 @inactiveModelId = m.id
    FROM Model m
    WHERE NOT EXISTS (
        SELECT 1 
        FROM Car c 
        JOIN Rental r ON c.licensePlate = r.carLicensePlate
        WHERE c.modelId = m.id 
        AND r.status = 'Активна' 
        AND r.actualReturnDate IS NULL
    );
    
    DECLARE @oldPrice DECIMAL(10,2), @newPrice DECIMAL(10,2);
    SELECT @oldPrice = dailyPrice FROM Model WHERE id = @inactiveModelId;
    SET @newPrice = @oldPrice * 1.15;
    
    UPDATE Model SET dailyPrice = @newPrice WHERE id = @inactiveModelId;
    
    -- Проверяем, что цена действительно изменилась
    DECLARE @updatedPrice DECIMAL(10,2);
    SELECT @updatedPrice = dailyPrice FROM Model WHERE id = @inactiveModelId;
    
    IF @updatedPrice = @newPrice
        PRINT 'УСПЕХ: Стоимость успешно изменена с ' + CAST(@oldPrice AS NVARCHAR) + ' на ' + CAST(@newPrice AS NVARCHAR);
    ELSE
        PRINT 'ОШИБКА: Цена не изменилась';
        
END TRY
BEGIN CATCH
    PRINT 'ОШИБКА: ' + ERROR_MESSAGE();
END CATCH

-- 3. ТЕСТИРОВАНИЕ ТРИГГЕРА НА УДАЛЕНИЕ АВТОМОБИЛЯ (ИСПРАВЛЕННЫЙ)
PRINT '=== ТЕСТ 3: Триггер на удаление автомобиля (ИСПРАВЛЕННЫЙ) ===';

-- Сначала создадим тестовые автомобили для проверки удаления
PRINT 'Создание тестовых автомобилей...';

-- Автомобиль, который можно удалить (удовлетворяет всем условиям)
IF NOT EXISTS (SELECT 1 FROM Car WHERE licensePlate = 'TEST001')
BEGIN
    INSERT INTO Car (licensePlate, year, color, condition, modelId)
    VALUES ('TEST001', 2005, 'Ржавый', 'Плохое', 1);
END

-- Автомобиль, который нельзя удалить (хорошее состояние)
IF NOT EXISTS (SELECT 1 FROM Car WHERE licensePlate = 'TEST002')
BEGIN
    INSERT INTO Car (licensePlate, year, color, condition, modelId)
    VALUES ('TEST002', 2005, 'Синий', 'Хорошее', 1);
END

-- Автомобиль, который нельзя удалить (молодой)
IF NOT EXISTS (SELECT 1 FROM Car WHERE licensePlate = 'TEST003')
BEGIN
    INSERT INTO Car (licensePlate, year, color, condition, modelId)
    VALUES ('TEST003', 2020, 'Красный', 'Плохое', 1);
END

-- Тест 3.1: Попытка удалить автомобиль, который НЕЛЬЗЯ удалить
PRINT 'Тест 3.1: Удаление автомобиля, не удовлетворяющего условиям';
BEGIN TRY
    DELETE FROM Car WHERE licensePlate = 'А001АА777'; -- Молодой, был в прокате, хорошее состояние
    PRINT 'ОШИБКА: Триггер не сработал!';
END TRY
BEGIN CATCH
    PRINT 'УСПЕХ: ' + ERROR_MESSAGE();
END CATCH

-- Тест 3.2: Удаление автомобиля, который МОЖНО удалить
PRINT 'Тест 3.2: Удаление автомобиля, удовлетворяющего условиям';
BEGIN TRY
    DELETE FROM Car WHERE licensePlate = 'TEST001';
    PRINT 'УСПЕХ: Автомобиль успешно удален';
    
    -- Проверяем, что автомобиль удален
    IF NOT EXISTS (SELECT 1 FROM Car WHERE licensePlate = 'TEST001')
        PRINT 'ПРОВЕРКА: Автомобиль TEST001 удален из базы';
    ELSE
        PRINT 'ОШИБКА: Автомобиль не был удален';
END TRY
BEGIN CATCH
    PRINT 'ОШИБКА: ' + ERROR_MESSAGE();
END CATCH

-- Тест 3.3: Попытка удалить автомобиль с хорошим состоянием
PRINT 'Тест 3.3: Удаление автомобиля с хорошим состоянием';
BEGIN TRY
    DELETE FROM Car WHERE licensePlate = 'TEST002';
    PRINT 'ОШИБКА: Удален автомобиль с хорошим состоянием!';
END TRY
BEGIN CATCH
    PRINT 'УСПЕХ: ' + ERROR_MESSAGE();
END CATCH

-- Тест 3.4: Попытка удалить молодой автомобиль
PRINT 'Тест 3.4: Удаление молодого автомобиля';
BEGIN TRY
    DELETE FROM Car WHERE licensePlate = 'TEST003';
    PRINT 'ОШИБКА: Удален молодой автомобиль!';
END TRY
BEGIN CATCH
    PRINT 'УСПЕХ: ' + ERROR_MESSAGE();
END CATCH
-- Очистка тестовых данных БЕЗ вызова триггера
PRINT 'Очистка тестовых данных...';

-- Удаляем без проверки условий (для тестовых данных)
DELETE FROM Car WHERE licensePlate = 'TEST002';
DELETE FROM Car WHERE licensePlate = 'TEST003';

PRINT 'Очистка завершена';
PRINT '';
PRINT '=== ТЕСТИРОВАНИЕ ЗАВЕРШЕНО ===';

-- ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА: Просмотр текущих данных
PRINT '';
PRINT '=== ПРОВЕРКА ДАННЫХ ПОСЛЕ ТЕСТИРОВАНИЯ ===';

PRINT '=== ПРОВЕРКА КЛИЕНТОВ С НАРУШЕНИЯМИ ===';

SELECT 
    c.passport,
    c.fullName,
    COUNT(r.id) as TotalRentals,
    COUNT(rf.rentalId) as RentalsWithFines,
    COUNT(CASE WHEN r.actualReturnDate > r.plannedReturnDate THEN 1 END) as LateReturns
FROM Client c
LEFT JOIN RentalOrder ro ON c.passport = ro.clientPassport
LEFT JOIN Rental r ON ro.id = r.rentalOrderId
LEFT JOIN RentalFine rf ON r.id = rf.rentalId
GROUP BY c.passport, c.fullName
HAVING COUNT(rf.rentalId) > 0 OR COUNT(CASE WHEN r.actualReturnDate > r.plannedReturnDate THEN 1 END) > 0;