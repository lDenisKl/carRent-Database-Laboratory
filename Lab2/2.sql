-- Доработанный скрипт с исправлениями ошибок

USE [Cars1]

-- Очистка существующих таблиц
IF OBJECT_ID('RentalFine', 'U') IS NOT NULL DROP TABLE RentalFine;
IF OBJECT_ID('Fine', 'U') IS NOT NULL DROP TABLE Fine;
IF OBJECT_ID('Rental', 'U') IS NOT NULL DROP TABLE Rental;
IF OBJECT_ID('ClientDiscount', 'U') IS NOT NULL DROP TABLE ClientDiscount;
IF OBJECT_ID('Discount', 'U') IS NOT NULL DROP TABLE Discount;
IF OBJECT_ID('RentalOrder', 'U') IS NOT NULL DROP TABLE RentalOrder;
IF OBJECT_ID('Car', 'U') IS NOT NULL DROP TABLE Car;
IF OBJECT_ID('Model', 'U') IS NOT NULL DROP TABLE Model;
IF OBJECT_ID('Client', 'U') IS NOT NULL DROP TABLE Client;

CREATE TABLE Model (
    id INT IDENTITY(1,1) PRIMARY KEY,
    name NVARCHAR(50) NOT NULL,
    type NVARCHAR(20) NOT NULL CHECK (type IN ('Седан', 'Внедорожник', 'Хэтчбек', 'Универсал', 'Купе', 'Минивэн')),
    manufacturer NVARCHAR(30) NOT NULL,
    dailyPrice DECIMAL(10, 2) NOT NULL CHECK (dailyPrice > 0)
);

CREATE TABLE Car (
    licensePlate NVARCHAR(15) PRIMARY KEY,
    year INT NOT NULL CHECK (year BETWEEN 1990 AND YEAR(GETDATE())),
    color NVARCHAR(20),
    condition NVARCHAR(20) NOT NULL CHECK (condition IN ('Идеальное', 'Хорошее', 'Удовлетворительное', 'Плохое')),
    modelId INT NOT NULL FOREIGN KEY REFERENCES Model(id) ON DELETE CASCADE
);

CREATE TABLE Client (
    passport NVARCHAR(20) PRIMARY KEY,
    fullName NVARCHAR(100) NOT NULL,
    address NVARCHAR(200),
    phone NVARCHAR(20) NOT NULL 
);

CREATE TABLE Discount (
    id INT IDENTITY(1,1) PRIMARY KEY,
    name NVARCHAR(50) NOT NULL,
    description NVARCHAR(200),
    rate DECIMAL(10, 2) NOT NULL CHECK (rate > 0), -- Увеличил точность для rate
    type NVARCHAR(20) NOT NULL CHECK (type IN ('Процент', 'Фиксированная')),
    isActive BIT NOT NULL DEFAULT 1
);

CREATE TABLE RentalOrder (
    id INT IDENTITY(1,1) PRIMARY KEY,
    createDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    status NVARCHAR(20) NOT NULL CHECK (status IN ('Создан', 'Подтвержден', 'Активен', 'Завершен', 'Отменен')),
    totalPrice DECIMAL(10, 2) CHECK (totalPrice >= 0),
    clientPassport NVARCHAR(20) NOT NULL FOREIGN KEY REFERENCES Client(passport) ON DELETE CASCADE
);

CREATE TABLE Rental (
    id INT IDENTITY(1,1) PRIMARY KEY,
    startDate DATETIME2 NOT NULL,
    plannedReturnDate DATETIME2 NOT NULL,
    actualReturnDate DATETIME2 NULL,
    rentalCost DECIMAL(10, 2) CHECK (rentalCost >= 0),
    status NVARCHAR(20) NOT NULL CHECK (status IN ('Активна', 'Завершена', 'Отменена')),
    carLicensePlate NVARCHAR(15) NOT NULL FOREIGN KEY REFERENCES Car(licensePlate) ON DELETE CASCADE,
    rentalOrderId INT NOT NULL FOREIGN KEY REFERENCES RentalOrder(id) ON DELETE CASCADE,
    CONSTRAINT CHK_Rental_Dates CHECK (plannedReturnDate > startDate AND (actualReturnDate IS NULL OR actualReturnDate >= startDate))
);

CREATE TABLE Fine (
    id INT IDENTITY(1,1) PRIMARY KEY,
    type NVARCHAR(50) NOT NULL CHECK (type IN ('Просрочка', 'Повреждение', 'Загрязнение', 'Утеря ключей')), -- Убрал 'Нарушение ПДД'
    description NVARCHAR(200),
    amount DECIMAL(10, 2) NOT NULL CHECK (amount > 0)
);

CREATE TABLE RentalFine (
    rentalId INT NOT NULL FOREIGN KEY REFERENCES Rental(id) ON DELETE CASCADE,
    fineId INT NOT NULL FOREIGN KEY REFERENCES Fine(id) ON DELETE CASCADE,
    PRIMARY KEY (rentalId, fineId)
);

CREATE TABLE ClientDiscount (
    clientPassport NVARCHAR(20) NOT NULL FOREIGN KEY REFERENCES Client(passport) ON DELETE CASCADE,
    discountId INT NOT NULL FOREIGN KEY REFERENCES Discount(id) ON DELETE CASCADE,
    PRIMARY KEY (clientPassport, discountId)
);

-- РАСШИРЕННЫЕ ТЕСТОВЫЕ ДАННЫЕ

-- Модели автомобилей (увеличил количество)
INSERT INTO Model (name, type, manufacturer, dailyPrice) VALUES
-- Toyota
('Camry', 'Седан', 'Toyota', 2500.00),
('RAV4', 'Внедорожник', 'Toyota', 3000.00),
('Corolla', 'Седан', 'Toyota', 2200.00),
('Land Cruiser', 'Внедорожник', 'Toyota', 5500.00),
('Hilux', 'Внедорожник', 'Toyota', 3200.00),
-- Hyundai
('Solaris', 'Седан', 'Hyundai', 2000.00),
('Creta', 'Внедорожник', 'Hyundai', 2800.00),
('Tucson', 'Внедорожник', 'Hyundai', 3500.00),
('Sonata', 'Седан', 'Hyundai', 2700.00),
('Santa Fe', 'Внедорожник', 'Hyundai', 4200.00),
-- BMW
('X5', 'Внедорожник', 'BMW', 6000.00),
('X3', 'Внедорожник', 'BMW', 4800.00),
('5 Series', 'Седан', 'BMW', 5200.00),
('3 Series', 'Седан', 'BMW', 4500.00),
('X7', 'Внедорожник', 'BMW', 7500.00),
-- Renault
('Logan', 'Седан', 'Renault', 1800.00),
('Duster', 'Внедорожник', 'Renault', 2600.00),
('Arkana', 'Купе', 'Renault', 2900.00),
('Kaptur', 'Внедорожник', 'Renault', 2400.00),
-- Lada
('Vesta', 'Седан', 'Lada', 1500.00),
('Granta', 'Седан', 'Lada', 1200.00),
('Niva', 'Внедорожник', 'Lada', 1700.00),
('XRAY', 'Хэтчбек', 'Lada', 1600.00),
-- Mercedes
('E-Class', 'Седан', 'Mercedes', 5800.00),
('GLE', 'Внедорожник', 'Mercedes', 6500.00),
('C-Class', 'Седан', 'Mercedes', 4900.00),
('S-Class', 'Седан', 'Mercedes', 8500.00);

-- Автомобили (значительно увеличил количество)
INSERT INTO Car (licensePlate, year, color, condition, modelId) VALUES
-- Toyota (10 авто)
('А001АА777', 2023, 'Белый', 'Идеальное', 1),
('А002АА777', 2024, 'Черный', 'Идеальное', 2),
('А003АА777', 2023, 'Серый', 'Хорошее', 3),
('А004АА777', 2022, 'Синий', 'Хорошее', 4),
('А005АА777', 2024, 'Красный', 'Идеальное', 5),
('А006АА777', 2023, 'Белый', 'Удовлетворительное', 1),
('А007АА777', 2022, 'Черный', 'Хорошее', 2),
('А008АА777', 2024, 'Серебристый', 'Идеальное', 3),
('А009АА777', 2023, 'Зеленый', 'Хорошее', 4),
('А010АА777', 2024, 'Белый', 'Идеальное', 5),
-- Hyundai (8 авто)
('В101ВВ777', 2023, 'Синий', 'Хорошее', 6),
('В102ВВ777', 2024, 'Белый', 'Идеальное', 7),
('В103ВВ777', 2023, 'Черный', 'Удовлетворительное', 8),
('В104ВВ777', 2022, 'Красный', 'Хорошее', 9),
('В105ВВ777', 2024, 'Серый', 'Идеальное', 10),
('В106ВВ777', 2023, 'Белый', 'Хорошее', 6),
('В107ВВ777', 2024, 'Синий', 'Идеальное', 7),
('В108ВВ777', 2023, 'Черный', 'Хорошее', 8),
-- BMW (6 авто)
('С201СС777', 2024, 'Черный', 'Идеальное', 11),
('С202СС777', 2023, 'Белый', 'Идеальное', 12),
('С203СС777', 2024, 'Синий', 'Хорошее', 13),
('С204СС777', 2023, 'Серый', 'Идеальное', 14),
('С205СС777', 2024, 'Красный', 'Идеальное', 15),
('С206СС777', 2023, 'Черный', 'Хорошее', 11),
-- Renault/Lada (8 авто)
('Е301ЕЕ777', 2022, 'Белый', 'Удовлетворительное', 16),
('Е302ЕЕ777', 2023, 'Синий', 'Хорошее', 17),
('Е303ЕЕ777', 2024, 'Красный', 'Идеальное', 18),
('Е304ЕЕ777', 2023, 'Серый', 'Хорошее', 19),
('Е305ЕЕ777', 2022, 'Белый', 'Плохое', 20),
('Е306ЕЕ777', 2024, 'Черный', 'Хорошее', 21),
('Е307ЕЕ777', 2023, 'Зеленый', 'Удовлетворительное', 22),
('Е308ЕЕ777', 2024, 'Синий', 'Идеальное', 23),
-- Mercedes (4 авто)
('Х401ХХ777', 2024, 'Черный', 'Идеальное', 24),
('Х402ХХ777', 2023, 'Белый', 'Идеальное', 25),
('Х403ХХ777', 2024, 'Серебристый', 'Идеальное', 26),
('Х404ХХ777', 2024, 'Синий', 'Идеальное', 27);

-- Клиенты (увеличил до 15)
INSERT INTO Client (passport, fullName, address, phone) VALUES
('4510 123456', 'Иванов Иван Иванович', 'г. Москва, ул. Ленина, д. 1', '+7 (999) 123-45-67'),
('4510 654321', 'Петров Петр Петрович', 'г. Санкт-Петербург, Невский пр-т, д. 10', '+7 (999) 765-43-21'),
('4510 111111', 'Сидорова Анна Сергеевна', 'г. Казань, ул. Баумана, д. 5', '+7 (999) 111-11-11'),
('4510 222222', 'Кузнецов Дмитрий Алексеевич', 'г. Екатеринбург, ул. Малышева, д. 15', '+7 (999) 222-22-22'),
('4510 333333', 'Новикова Елена Викторовна', 'г. Москва, ул. Тверская, д. 25', '+7 (999) 333-33-33'),
('4510 444444', 'Васильев Алексей Петрович', 'г. Новосибирск, ул. Кирова, д. 8', '+7 (999) 444-44-44'),
('4510 555555', 'Морозова Ольга Дмитриевна', 'г. Сочи, ул. Набережная, д. 12', '+7 (999) 555-55-55'),
('4510 666666', 'Лебедев Сергей Иванович', 'г. Калининград, ул. Гагарина, д. 3', '+7 (999) 666-66-66'),
('4510 777777', 'Ковалева Мария Сергеевна', 'г. Москва, ул. Арбат, д. 40', '+7 (999) 777-77-77'),
('4510 888888', 'Соколов Андрей Николаевич', 'г. Владивосток, ул. Светланская, д. 7', '+7 (999) 888-88-88'),
('4510 999999', 'Попова Ирина Владимировна', 'г. Ростов-на-Дону, ул. Большая Садовая, д. 18', '+7 (999) 999-99-99'),
('4520 123456', 'Федоров Максим Олегович', 'г. Москва, пр-т Мира, д. 65', '+7 (999) 123-00-00'),
('4520 654321', 'Никитина Татьяна Борисовна', 'г. Самара, ул. Куйбышева, д. 22', '+7 (999) 765-00-00'),
('4520 111111', 'Орлов Денис Викторович', 'г. Воронеж, ул. Плехановская, д. 9', '+7 (999) 111-00-00'),
('4520 222222', 'Жукова Светлана Анатольевна', 'г. Пермь, ул. Ленина, д. 33', '+7 (999) 222-00-00');

-- Скидки (ИСПРАВЛЕНО: rate с большей точностью)
INSERT INTO Discount (name, description, rate, type, isActive) VALUES
('Приветственная', 'Скидка для новых клиентов', 5.00, 'Процент', 1),
('Постоянный клиент', 'Для клиентов с 3+ арендами', 10.00, 'Процент', 1),
('Зимняя акция', 'Специальное предложение на зимние месяцы', 15.00, 'Процент', 0),
('Фикс скидка', 'Скидка на дорогие модели', 1000.00, 'Фиксированная', 1),
('Летняя акция', 'Скидка на аренду в летний период', 8.00, 'Процент', 1),
('Корпоративная', 'Скидка для корпоративных клиентов', 12.00, 'Процент', 1),
('Предоплата', 'Скидка при 100% предоплате', 7.00, 'Процент', 1);

-- Заказы (много данных за 2025 год)
INSERT INTO RentalOrder (createDate, status, totalPrice, clientPassport) VALUES
-- Январь 2025
('2025-01-05 10:00:00', 'Завершен', 12500.00, '4510 123456'),
('2025-01-12 14:30:00', 'Завершен', 18000.00, '4510 654321'),
('2025-01-20 09:15:00', 'Завершен', 21000.00, '4510 111111'),
-- Февраль 2025
('2025-02-03 11:20:00', 'Завершен', 15000.00, '4510 222222'),
('2025-02-15 16:45:00', 'Завершен', 32000.00, '4510 333333'),
('2025-02-28 13:10:00', 'Завершен', 28000.00, '4510 123456'),
-- Март 2025
('2025-03-10 08:30:00', 'Завершен', 19500.00, '4510 444444'),
('2025-03-18 12:15:00', 'Завершен', 22500.00, '4510 555555'),
('2025-03-25 17:20:00', 'Завершен', 26500.00, '4510 654321'),
-- Апрель 2025
('2025-04-05 09:45:00', 'Завершен', 14200.00, '4510 666666'),
('2025-04-12 14:20:00', 'Завершен', 17800.00, '4510 777777'),
('2025-04-28 11:30:00', 'Завершен', 19800.00, '4510 888888'),
-- Май 2025
('2025-05-03 10:15:00', 'Завершен', 21500.00, '4510 999999'),
('2025-05-15 13:40:00', 'Завершен', 18500.00, '4520 123456'),
('2025-05-22 16:25:00', 'Завершен', 24500.00, '4520 654321'),
-- Июнь 2025
('2025-06-07 08:50:00', 'Завершен', 16200.00, '4520 111111'),
('2025-06-18 12:35:00', 'Завершен', 22800.00, '4520 222222'),
('2025-06-29 15:10:00', 'Завершен', 19200.00, '4510 123456'),
-- Июль 2025 (текущие активные заказы)
('2025-07-01 09:20:00', 'Активен', NULL, '4510 333333'),
('2025-07-03 11:45:00', 'Активен', NULL, '4510 444444'),
('2025-07-05 14:30:00', 'Подтвержден', NULL, '4510 555555'),
('2025-07-07 16:15:00', 'Создан', NULL, '4510 666666'),
('2025-07-10 10:00:00', 'Активен', NULL, '4510 777777'),
-- Август 2025 (будущие заказы)
('2025-08-01 12:00:00', 'Создан', NULL, '4510 888888'),
('2025-08-05 14:00:00', 'Создан', NULL, '4510 999999'),
('2025-08-10 09:30:00', 'Создан', NULL, '4520 123456'),
-- Отмененные заказы
('2025-03-15 10:00:00', 'Отменен', 0.00, '4520 654321'),
('2025-05-20 14:00:00', 'Отменен', 0.00, '4520 111111'),
('2025-06-25 16:00:00', 'Отменен', 0.00, '4520 222222');

INSERT INTO Rental (startDate, plannedReturnDate, actualReturnDate, rentalCost, status, carLicensePlate, rentalOrderId) VALUES
-- Январь 2025
('2025-01-05 10:00:00', '2025-01-10 10:00:00', '2025-01-10 09:30:00', 12500.00, 'Завершена', 'А001АА777', 1),
('2025-01-12 14:30:00', '2025-01-18 14:30:00', '2025-01-18 15:00:00', 18000.00, 'Завершена', 'В101ВВ777', 2),
('2025-01-20 09:15:00', '2025-01-25 09:15:00', '2025-01-25 10:00:00', 21000.00, 'Завершена', 'С201СС777', 3),
-- Февраль 2025
('2025-02-03 11:20:00', '2025-02-08 11:20:00', '2025-02-08 11:00:00', 15000.00, 'Завершена', 'А002АА777', 4),
('2025-02-15 16:45:00', '2025-02-20 16:45:00', '2025-02-20 17:15:00', 32000.00, 'Завершена', 'Х401ХХ777', 5),
('2025-02-28 13:10:00', '2025-03-05 13:10:00', '2025-03-05 12:45:00', 28000.00, 'Завершена', 'В102ВВ777', 6),
-- Март 2025
('2025-03-10 08:30:00', '2025-03-15 08:30:00', '2025-03-15 09:00:00', 19500.00, 'Завершена', 'А003АА777', 7),
('2025-03-18 12:15:00', '2025-03-23 12:15:00', '2025-03-23 11:45:00', 22500.00, 'Завершена', 'С202СС777', 8),
('2025-03-25 17:20:00', '2025-03-30 17:20:00', '2025-03-30 16:50:00', 26500.00, 'Завершена', 'В103ВВ777', 9),
-- Апрель 2025
('2025-04-05 09:45:00', '2025-04-10 09:45:00', '2025-04-10 09:15:00', 14200.00, 'Завершена', 'Е301ЕЕ777', 10),
('2025-04-12 14:20:00', '2025-04-17 14:20:00', '2025-04-17 14:50:00', 17800.00, 'Завершена', 'А004АА777', 11),
('2025-04-28 11:30:00', '2025-05-03 11:30:00', '2025-05-03 11:00:00', 19800.00, 'Завершена', 'С203СС777', 12),
-- Май 2025
('2025-05-03 10:15:00', '2025-05-08 10:15:00', '2025-05-08 09:45:00', 21500.00, 'Завершена', 'В104ВВ777', 13),
('2025-05-15 13:40:00', '2025-05-20 13:40:00', '2025-05-20 14:10:00', 18500.00, 'Завершена', 'А005АА777', 14),
('2025-05-22 16:25:00', '2025-05-27 16:25:00', '2025-05-27 16:55:00', 24500.00, 'Завершена', 'Х402ХХ777', 15),
-- Июнь 2025
('2025-06-07 08:50:00', '2025-06-12 08:50:00', '2025-06-12 09:20:00', 16200.00, 'Завершена', 'Е302ЕЕ777', 16),
('2025-06-18 12:35:00', '2025-06-23 12:35:00', '2025-06-23 13:05:00', 22800.00, 'Завершена', 'С204СС777', 17),
('2025-06-29 15:10:00', '2025-07-04 15:10:00', '2025-07-04 14:40:00', 19200.00, 'Завершена', 'В105ВВ777', 18),
-- Июль 2025 (активные аренды)
('2025-07-01 09:20:00', '2025-07-06 09:20:00', NULL, 13500.00, 'Активна', 'А006АА777', 19),
('2025-07-03 11:45:00', '2025-07-08 11:45:00', NULL, 16800.00, 'Активна', 'В106ВВ777', 20),
('2025-07-05 14:30:00', '2025-07-10 14:30:00', NULL, 19500.00, 'Активна', 'Е305ЕЕ777', 21),
('2025-07-07 16:15:00', '2025-07-12 16:15:00', NULL, 14200.00, 'Активна', 'А009АА777', 22),
('2025-07-10 10:00:00', '2025-07-15 10:00:00', NULL, 24500.00, 'Активна', 'С205СС777', 23),
-- Август 2025 (будущие аренды)
('2025-08-01 12:00:00', '2025-08-06 12:00:00', NULL, 15800.00, 'Активна', 'Е303ЕЕ777', 24),
('2025-08-05 14:00:00', '2025-08-10 14:00:00', NULL, 17200.00, 'Активна', 'А007АА777', 25),
('2025-08-10 09:30:00', '2025-08-15 09:30:00', NULL, 19800.00, 'Активна', 'В107ВВ777', 26),
-- Аренды с просрочками (ДОБАВЛЕНО: правильные rentalOrderId)
('2025-04-15 10:00:00', '2025-04-20 10:00:00', '2025-04-21 11:00:00', 15200.00, 'Завершена', 'Е304ЕЕ777', 27),
('2025-05-10 14:00:00', '2025-05-15 14:00:00', '2025-05-16 09:00:00', 16800.00, 'Завершена', 'А008АА777', 28);
-- Штрафы (ИСПРАВЛЕНО: убрал 'Нарушение ПДД' из CHECK constraint)
INSERT INTO Fine (type, description, amount) VALUES
('Просрочка', 'Возврат автомобиля с опозданием', 1000.00),
('Повреждение', 'Царапина на бампере', 5000.00),
('Загрязнение', 'Сильное загрязнение салона', 2000.00),
('Утеря ключей', 'Утеря комплекта ключей', 3000.00),
('Повреждение', 'Вмятина на двери', 8000.00),
('Повреждение', 'Разбитое стекло', 12000.00);

INSERT INTO RentalFine (rentalId, fineId) VALUES
(27, 1), -- Просрочка возврата (аренда с ID 27)
(28, 1), -- Просрочка возврата (аренда с ID 28)
(3, 2),  -- Царапина на бампере (аренда с ID 3)
(8, 3),  -- Загрязнение салона (аренда с ID 8)
(12, 4), -- Утеря ключей (аренда с ID 12)
(7, 5),  -- Вмятина на двери (аренда с ID 7)
(15, 6); -- Разбитое стекло (аренда с ID 15)

-- Связи клиентов со скидками (ИСПРАВЛЕНО: правильные discountId)
INSERT INTO ClientDiscount (clientPassport, discountId) VALUES
('4510 123456', 2), -- Иванов - постоянный клиент
('4510 123456', 4), -- Иванов - фиксированная скидка
('4510 654321', 1), -- Петров - приветственная
('4510 333333', 2), -- Новикова - постоянный клиент
('4510 444444', 5), -- Васильев - летняя акция
('4510 777777', 6), -- Ковалева - корпоративная
('4510 888888', 7), -- Соколов - предоплата
('4520 123456', 1), -- Федоров - приветственная
('4520 222222', 2); -- Жукова - постоянный клиент


SELECT * FROM Model;
SELECT * FROM Car;
SELECT * FROM Client;
SELECT * FROM Discount;
SELECT * FROM RentalOrder;
SELECT * FROM Rental;
SELECT * FROM Fine;
SELECT * FROM RentalFine;
SELECT * FROM ClientDiscount;